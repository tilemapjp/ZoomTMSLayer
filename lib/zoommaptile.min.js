/* Copyright (c) 2012 OHTSUKA Ko-hei */ZoomingTMS=function(e,t){if(typeof e=="undefined"||typeof t=="undefined")throw new Error("Both map object & options are required.");if(typeof t.url=="undefined")throw new Error("Url property is required.");if(typeof t.layername=="undefined")throw new Error("Layername property is required.");if(typeof t.tileMaxZoom=="undefined")throw new Error("TileMaxZoom property is required.");this.tileSize=new google.maps.Size(256,256),this.map=e,this.tiles=[],this.visible=!0;for(var n in t)this[n]=t[n]},ZoomingTMS.prototype=new google.maps.OverlayView,ZoomingTMS.prototype.maxZoom=null,ZoomingTMS.prototype.minZoom=0,ZoomingTMS.prototype.tileMaxZoom=null,ZoomingTMS.prototype.name="",ZoomingTMS.prototype.alt="",ZoomingTMS.prototype.serviceVersion="1.0.0",ZoomingTMS.prototype.layername=null,ZoomingTMS.prototype.type="png",ZoomingTMS.prototype.isTMSYAxis=!1,ZoomingTMS.prototype.opacity=100,ZoomingTMS.prototype.getTile=function(e,t,n){if(this.maxZoom!==null&&t>this.maxZoom||t<this.minZoom)return null;var r="t_"+e.x+"_"+e.y+"_"+t;for(var i=0;i<this.tiles.length;i++)if(this.tiles[i].id==r)return this.setObjectOpacity(this.tiles[i]),this.tiles[i];var s=n.createElement("div");s.id=r,s.style.width=this.tileSize.width+"px",s.style.height=this.tileSize.height+"px";var o=t-this.tileMaxZoom;o<0&&(o=0);var u=this.isTMSYAxis?e.y:(1<<t)-e.y-1,a={x:e.x,y:u},f=n.createElement("img");f.style.width=this.tileSize.width+"px",f.style.height=this.tileSize.height+"px";var l;if(o>0){var c=Math.pow(2,o),h=256*(c-1)/(c*2),p=256/c,d=a.x%c,v=h-d*p,m=c-a.y%c-1,g=-m*p;a.x=Math.floor(a.x/c),a.y=Math.floor(a.y/c);var y="scale("+c+","+c+") translate("+v+"px,"+g+"px)";l=n.createElement("div"),typeof l.style.transform=="string"&&(l.style.transform=y),typeof l.style.msTransform=="string"&&(l.style.msTransform=y),typeof l.style.webkitTransform=="string"&&(l.style.webkitTransform=y),typeof l.style.MozTransform=="string"&&(l.style.MozTransform=y),typeof l.style.OTransform=="string"&&(l.style.OTransform=y),l.style.border="0px",f.style.position="absolute",f.style.clip="rect("+m*p+"px,"+(d+1)*p+"px,"+(m+1)*p+"px,"+d*p+"px)",console.log(f.style.clip),s.appendChild(l)}else l=s;return f.onload=function(){l.appendChild(f),f=null,s=null,l=null},f.onerror=function(){f=null,s=null,l=null},f.src=this.getTileUrl(a,t-o),this.visible||(s.style.display="none"),this.tiles.push(s),this.setObjectOpacity(s),s},ZoomingTMS.prototype.deleteHiddenTiles=function(e){var t=this.map.getBounds(),n=this.getTileUrlCoordFromLatLng(t.getNorthEast(),e),r=this.getTileUrlCoordFromLatLng(t.getSouthWest(),e),i=r.x-1,s=n.x+1,o=r.y-1,u=n.y+1,a=[],f=this.tiles.length;for(var l=0;l<f;l++){var c=this.tiles[l].id.split("_"),h=Number(c[1]),p=Number(c[2]),d=Number(c[3]);(i<s&&h>=i&&h<=s||i>s&&(h>=i&&h<=Math.pow(2,e)-1||h>=0&&h<=s))&&p>=o&&p<=u&&d==e?a.push(this.tiles[l]):delete this.tiles[l]}this.tiles=a},ZoomingTMS.prototype.pointToTile=function(e,t){var n=this.map.getProjection(),r=n.fromLatLngToPoint(e),i=new google.maps.Point(r.x*Math.pow(2,t),r.y*Math.pow(2,t)),s=new google.maps.Point(Math.floor(i.x/this.tileSize.width),Math.floor(i.y/this.tileSize.height));return s},ZoomingTMS.prototype.getTileUrlCoordFromLatLng=function(e,t){return this.getTileUrlCoord(this.pointToTile(e,t),t)},ZoomingTMS.prototype.getTileUrlCoord=function(e,t){var n=1<<t,r=n-e.y-1,i=e.x;if(i<0||i>=n)i=(i%n+n)%n;return new google.maps.Point(i,r)},ZoomingTMS.prototype.getTileUrl=function(e,t){var n=this.layername+"/"+t+"/"+e.x+"/"+e.y+"."+this.type;return this.serviceVersion!=""&&(n=this.serviceVersion+"/"+n),this.url+n},ZoomingTMS.prototype.hide=function(){this.visible=!1;var e=this.tiles.length;for(var t=0;t<e;t++)this.tiles[t].style.display="none"},ZoomingTMS.prototype.show=function(){this.visible=!0;var e=this.tiles.length;for(var t=0;t<e;t++)this.tiles[t].style.display=""},ZoomingTMS.prototype.releaseTile=function(e){e=null},ZoomingTMS.prototype.setOpacity=function(e){this.opacity=e;var t=this.tiles.length;for(var n=0;n<t;n++)this.setObjectOpacity(this.tiles[n])},ZoomingTMS.prototype.setObjectOpacity=function(e){typeof e.style.filter=="string"&&(e.style.filter="alpha(opacity:"+this.opacity+")"),typeof e.style.KHTMLOpacity=="string"&&(e.style.KHTMLOpacity=this.opacity/100),typeof e.style.MozOpacity=="string"&&(e.style.MozOpacity=this.opacity/100),typeof e.style.opacity=="string"&&(e.style.opacity=this.opacity/100)};